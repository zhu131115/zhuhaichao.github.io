<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>朱海潮网</title>
	</head>
	<body>
		<h1>欢迎</h1>
		<p>在此声明本站基于github的网站功能</p>
		<p>你们可以在这说点什么</p>
		   <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
    }
    .guestbook {
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .message-list {
      margin-top: 20px;
    }
    .message {
      padding: 15px;
      border-bottom: 1px solid #eee;
      background: #f9f9f9;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .loading {
      display: none;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="guestbook">
    <form id="messageForm">
      <input type="text" id="name" placeholder="你的名字" required>
      <textarea id="content" placeholder="留言内容" required></textarea>
      <button type="submit">提交留言</button>
      <div class="loading" id="loading">正在提交...</div>
    </form>
    
    <div id="messages" class="message-list"></div>
  </div>

  <script>
    // 配置信息（请替换为你的GitHub Token和用户名）
    const GITHUB_TOKEN = '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';  // 替换为你的GitHub Personal Access Token
    const USERNAME = 'zhu131115';     // 替换为你的GitHub用户名

    // 提交留言到GitHub Gist
    async function postMessage(message) {
      try {
        const response = await fetch('https://api.github.com/gists', {
          method: 'POST',
          headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            description: '留言板数据',
            public: true,
            files: {
              [`message-${Date.now()}.txt`]: {
                content: JSON.stringify(message)
              }
            }
          })
        });
        
        if (!response.ok) throw new Error('提交失败');
        return await response.json();
      } catch (error) {
        console.error('提交错误:', error);
        alert('提交留言失败，请重试');
      }
    }

    // 获取所有留言
    async function getMessages() {
      try {
        const response = await fetch(`https://api.github.com/users/${USERNAME}/gists`);
        if (!response.ok) throw new Error('获取失败');
        
        const data = await response.json();
        
        return data
          .filter(gist => Object.keys(gist.files).some(key => key.startsWith('message-')))
          .map(gist => {
            const filename = Object.keys(gist.files).find(key => key.startsWith('message-'));
            return {
              id: gist.id,
              url: gist.html_url,
              ...JSON.parse(gist.files[filename].content)
            };
          });
      } catch (error) {
        console.error('获取错误:', error);
        alert('加载留言失败');
        return [];
      }
    }

    // 显示留言
    function displayMessages(messages) {
      const container = document.getElementById('messages');
      container.innerHTML = '';
      
      if (messages.length === 0) {
        container.innerHTML = '<p>暂无留言</p>';
        return;
      }
      
      messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `<strong>${escapeHtml(msg.name)}</strong>：<br>${escapeHtml(msg.content)}<br><small>${msg.timestamp}</small>`;
        container.appendChild(div);
      });
    }

    // 转义HTML防止XSS
    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;',
        '"': '&quot;', "'": '&#39;'
      }[m]));
    }

    // 表单提交处理
    document.getElementById('messageForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const loading = document.getElementById('loading');
      
      try {
        loading.style.display = 'block';
        
        const name = document.getElementById('name').value.trim();
        const content = document.getElementById('content').value.trim();
        
        if (!name || !content) {
          alert('请输入姓名和留言内容');
          return;
        }
        
        const message = {
          name,
          content,
          timestamp: new Date().toLocaleString()
        };
        
        await postMessage(message);
        await loadMessages(); // 重新加载留言
        this.reset();
      } finally {
        loading.style.display = 'none';
      }
    });

    // 初始化加载留言
    async function loadMessages() {
      const messages = await getMessages();
      displayMessages(messages);
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', loadMessages);
  </script>
	</body>
</html>
